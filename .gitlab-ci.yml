stages:
  - push

push_to_vm:
  stage: push
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client git bash
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > id_rsa
    - chmod 600 id_rsa
    - ssh-add id_rsa
  script:
    - |
      ssh -o StrictHostKeyChecking=no ubuntu@13.60.255.157 << 'EOF'
        set -e  # Exit on any failure
        echo '[+] Connected to server.'

        REPO_DIR="/var/www/flask-apache-ubuntu-host"
        REPO_URL="git@gitlab.com:manojtharindu11/flask-apache-ubuntu-host.git"
        VENV_DIR=".venv"
        APACHE_CONF="flask-apache-ubuntu-host.conf"
        APACHE_CONF_PATH="/etc/apache2/sites-available/$APACHE_CONF"

        # Step 1: Clone or pull repository
        if [ -d "$REPO_DIR" ]; then
          cd "$REPO_DIR" || exit 1
          if [ -d .git ]; then
            echo '[+] Pulling latest changes...'
            git pull origin main
          else
            echo '[!] Not a git repo. Replacing contents...'
            sudo rm -rf "$REPO_DIR"
            git clone "$REPO_URL" "$REPO_DIR"
            cd "$REPO_DIR"
          fi
        else
          echo '[+] Cloning repository...'
          git clone "$REPO_URL" "$REPO_DIR"
          cd "$REPO_DIR"
        fi

        # Step 2: Set up virtual environment
        if [ -d "$VENV_DIR" ]; then
          echo '[+] Virtual environment exists.'
        else
          echo '[+] Creating virtual environment...'
          python3 -m venv "$VENV_DIR"
        fi

        echo '[+] Activating virtual environment...'
        source "$VENV_DIR/bin/activate"

        echo '[+] Installing requirements...'
        pip install --upgrade pip
        pip install -r requirements.txt

        echo '[+] Updating Apache config...'
        sudo cp "$APACHE_CONF" "$APACHE_CONF_PATH"
        sudo a2enmod proxy
        sudo a2enmod proxy_http
        sudo a2ensite "$APACHE_CONF"

        echo '[+] Validating Apache config...'
        sudo apachectl configtest || exit 1

        echo '[+] Reloading Apache...'
        sudo systemctl reload apache2


        # Step 4: Start Gunicorn using your script
        echo '[+] Running Gunicorn via run.sh...'
        chmod +x run.sh
        ./run.sh

        echo '[âœ“] Deployment finished.'
      EOF
  only:
    - main
